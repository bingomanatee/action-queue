!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self)["@wonderlandlabs/action_queue"]=e()}(this,(function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(e,r)};function e(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}function r(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function n(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,o,i=r.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s}function o(t,e,r){if(r||2===arguments.length)for(var n,o=0,i=e.length;o<i;o++)!n&&o in e||(n||(n=Array.prototype.slice.call(e,0,o)),n[o]=e[o]);return t.concat(n||Array.prototype.slice.call(e))}function i(t){return"function"==typeof t}function s(t){var e=t((function(t){Error.call(t),t.stack=(new Error).stack}));return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e}var u=s((function(t){return function(e){t(this),this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map((function(t,e){return e+1+") "+t.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e}}));function a(t,e){if(t){var r=t.indexOf(e);0<=r&&t.splice(r,1)}}var c=function(){function t(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._teardowns=null}var e;return t.prototype.unsubscribe=function(){var t,e,s,a,c;if(!this.closed){this.closed=!0;var l=this._parentage;if(l)if(this._parentage=null,Array.isArray(l))try{for(var f=r(l),h=f.next();!h.done;h=f.next()){h.value.remove(this)}}catch(e){t={error:e}}finally{try{h&&!h.done&&(e=f.return)&&e.call(f)}finally{if(t)throw t.error}}else l.remove(this);var v=this.initialTeardown;if(i(v))try{v()}catch(t){c=t instanceof u?t.errors:[t]}var d=this._teardowns;if(d){this._teardowns=null;try{for(var y=r(d),b=y.next();!b.done;b=y.next()){var m=b.value;try{p(m)}catch(t){c=null!=c?c:[],t instanceof u?c=o(o([],n(c)),n(t.errors)):c.push(t)}}}catch(t){s={error:t}}finally{try{b&&!b.done&&(a=y.return)&&a.call(y)}finally{if(s)throw s.error}}}if(c)throw new u(c)}},t.prototype.add=function(e){var r;if(e&&e!==this)if(this.closed)p(e);else{if(e instanceof t){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._teardowns=null!==(r=this._teardowns)&&void 0!==r?r:[]).push(e)}},t.prototype._hasParent=function(t){var e=this._parentage;return e===t||Array.isArray(e)&&e.includes(t)},t.prototype._addParent=function(t){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(t),e):e?[e,t]:t},t.prototype._removeParent=function(t){var e=this._parentage;e===t?this._parentage=null:Array.isArray(e)&&a(e,t)},t.prototype.remove=function(e){var r=this._teardowns;r&&a(r,e),e instanceof t&&e._removeParent(this)},t.EMPTY=((e=new t).closed=!0,e),t}(),l=c.EMPTY;function f(t){return t instanceof c||t&&"closed"in t&&i(t.remove)&&i(t.add)&&i(t.unsubscribe)}function p(t){i(t)?t():t.unsubscribe()}var h={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},v={setTimeout:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=v.delegate;return((null==r?void 0:r.setTimeout)||setTimeout).apply(void 0,o([],n(t)))},clearTimeout:function(t){var e=v.delegate;return((null==e?void 0:e.clearTimeout)||clearTimeout)(t)},delegate:void 0};function d(){}var y=null;function b(t){if(h.useDeprecatedSynchronousErrorHandling){var e=!y;if(e&&(y={errorThrown:!1,error:null}),t(),e){var r=y,n=r.errorThrown,o=r.error;if(y=null,n)throw o}}else t()}var m=function(t){function r(e){var r=t.call(this)||this;return r.isStopped=!1,e?(r.destination=e,f(e)&&e.add(r)):r.destination=E,r}return e(r,t),r.create=function(t,e,r){return new x(t,e,r)},r.prototype.next=function(t){this.isStopped||this._next(t)},r.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},r.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},r.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this),this.destination=null)},r.prototype._next=function(t){this.destination.next(t)},r.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},r.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},r}(c),w=Function.prototype.bind;function _(t,e){return w.call(t,e)}var g=function(){function t(t){this.partialObserver=t}return t.prototype.next=function(t){var e=this.partialObserver;if(e.next)try{e.next(t)}catch(t){S(t)}},t.prototype.error=function(t){var e=this.partialObserver;if(e.error)try{e.error(t)}catch(t){S(t)}else S(t)},t.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(t){S(t)}},t}(),x=function(t){function r(e,r,n){var o,s,u=t.call(this)||this;i(e)||!e?o={next:null!=e?e:void 0,error:null!=r?r:void 0,complete:null!=n?n:void 0}:u&&h.useDeprecatedNextContext?((s=Object.create(e)).unsubscribe=function(){return u.unsubscribe()},o={next:e.next&&_(e.next,s),error:e.error&&_(e.error,s),complete:e.complete&&_(e.complete,s)}):o=e;return u.destination=new g(o),u}return e(r,t),r}(m);function S(t){var e;e=t,v.setTimeout((function(){throw e}))}var E={closed:!0,next:d,error:function(t){throw t},complete:d},k="function"==typeof Symbol&&Symbol.observable||"@@observable";function L(t){return t}function T(t){return 0===t.length?L:1===t.length?t[0]:function(e){return t.reduce((function(t,e){return e(t)}),e)}}var C=function(){function t(t){t&&(this._subscribe=t)}return t.prototype.lift=function(e){var r=new t;return r.source=this,r.operator=e,r},t.prototype.subscribe=function(t,e,r){var n,o=this,s=(n=t)&&n instanceof m||function(t){return t&&i(t.next)&&i(t.error)&&i(t.complete)}(n)&&f(n)?t:new x(t,e,r);return b((function(){var t=o,e=t.operator,r=t.source;s.add(e?e.call(s,r):r?o._subscribe(s):o._trySubscribe(s))})),s},t.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){t.error(e)}},t.prototype.forEach=function(t,e){var r=this;return new(e=O(e))((function(e,n){var o=new x({next:function(e){try{t(e)}catch(t){n(t),o.unsubscribe()}},error:n,complete:e});r.subscribe(o)}))},t.prototype._subscribe=function(t){var e;return null===(e=this.source)||void 0===e?void 0:e.subscribe(t)},t.prototype[k]=function(){return this},t.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return T(t)(this)},t.prototype.toPromise=function(t){var e=this;return new(t=O(t))((function(t,r){var n;e.subscribe((function(t){return n=t}),(function(t){return r(t)}),(function(){return t(n)}))}))},t.create=function(e){return new t(e)},t}();function O(t){var e;return null!==(e=null!=t?t:h.Promise)&&void 0!==e?e:Promise}var A=s((function(t){return function(){t(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}})),P=function(t){function n(){var e=t.call(this)||this;return e.closed=!1,e.observers=[],e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return e(n,t),n.prototype.lift=function(t){var e=new j(this,this);return e.operator=t,e},n.prototype._throwIfClosed=function(){if(this.closed)throw new A},n.prototype.next=function(t){var e=this;b((function(){var n,o;if(e._throwIfClosed(),!e.isStopped){var i=e.observers.slice();try{for(var s=r(i),u=s.next();!u.done;u=s.next()){u.value.next(t)}}catch(t){n={error:t}}finally{try{u&&!u.done&&(o=s.return)&&o.call(s)}finally{if(n)throw n.error}}}}))},n.prototype.error=function(t){var e=this;b((function(){if(e._throwIfClosed(),!e.isStopped){e.hasError=e.isStopped=!0,e.thrownError=t;for(var r=e.observers;r.length;)r.shift().error(t)}}))},n.prototype.complete=function(){var t=this;b((function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var e=t.observers;e.length;)e.shift().complete()}}))},n.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=null},Object.defineProperty(n.prototype,"observed",{get:function(){var t;return(null===(t=this.observers)||void 0===t?void 0:t.length)>0},enumerable:!1,configurable:!0}),n.prototype._trySubscribe=function(e){return this._throwIfClosed(),t.prototype._trySubscribe.call(this,e)},n.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},n.prototype._innerSubscribe=function(t){var e=this.hasError,r=this.isStopped,n=this.observers;return e||r?l:(n.push(t),new c((function(){return a(n,t)})))},n.prototype._checkFinalizedStatuses=function(t){var e=this.hasError,r=this.thrownError,n=this.isStopped;e?t.error(r):n&&t.complete()},n.prototype.asObservable=function(){var t=new C;return t.source=this,t},n.create=function(t,e){return new j(t,e)},n}(C),j=function(t){function r(e,r){var n=t.call(this)||this;return n.destination=e,n.source=r,n}return e(r,t),r.prototype.next=function(t){var e,r;null===(r=null===(e=this.destination)||void 0===e?void 0:e.next)||void 0===r||r.call(e,t)},r.prototype.error=function(t){var e,r;null===(r=null===(e=this.destination)||void 0===e?void 0:e.error)||void 0===r||r.call(e,t)},r.prototype.complete=function(){var t,e;null===(e=null===(t=this.destination)||void 0===t?void 0:t.complete)||void 0===e||e.call(t)},r.prototype._subscribe=function(t){var e,r;return null!==(r=null===(e=this.source)||void 0===e?void 0:e.subscribe(t))&&void 0!==r?r:l},r}(P),N=function(t){function r(e){var r=t.call(this)||this;return r._value=e,r}return e(r,t),Object.defineProperty(r.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),r.prototype._subscribe=function(e){var r=t.prototype._subscribe.call(this,e);return!r.closed&&e.next(this._value),r},r.prototype.getValue=function(){var t=this.hasError,e=this.thrownError,r=this._value;if(t)throw e;return this._throwIfClosed(),r},r.prototype.next=function(e){t.prototype.next.call(this,this._value=e)},r}(P);function M(){}function D(){D.init.call(this)}function I(t){return void 0===t._maxListeners?D.defaultMaxListeners:t._maxListeners}function q(t,e,r){if(e)t.call(r);else for(var n=t.length,o=Y(t,n),i=0;i<n;++i)o[i].call(r)}function U(t,e,r,n){if(e)t.call(r,n);else for(var o=t.length,i=Y(t,o),s=0;s<o;++s)i[s].call(r,n)}function F(t,e,r,n,o){if(e)t.call(r,n,o);else for(var i=t.length,s=Y(t,i),u=0;u<i;++u)s[u].call(r,n,o)}function $(t,e,r,n,o,i){if(e)t.call(r,n,o,i);else for(var s=t.length,u=Y(t,s),a=0;a<s;++a)u[a].call(r,n,o,i)}function z(t,e,r,n){if(e)t.apply(r,n);else for(var o=t.length,i=Y(t,o),s=0;s<o;++s)i[s].apply(r,n)}function H(t,e,r,n){var o,i,s,u;if("function"!=typeof r)throw new TypeError('"listener" argument must be a function');if((i=t._events)?(i.newListener&&(t.emit("newListener",e,r.listener?r.listener:r),i=t._events),s=i[e]):(i=t._events=new M,t._eventsCount=0),s){if("function"==typeof s?s=i[e]=n?[r,s]:[s,r]:n?s.unshift(r):s.push(r),!s.warned&&(o=I(t))&&o>0&&s.length>o){s.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+e+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=t,a.type=e,a.count=s.length,u=a,"function"==typeof console.warn?console.warn(u):console.log(u)}}else s=i[e]=r,++t._eventsCount;return t}function J(t,e,r){var n=!1;function o(){t.removeListener(e,o),n||(n=!0,r.apply(t,arguments))}return o.listener=r,o}function V(t){var e=this._events;if(e){var r=e[t];if("function"==typeof r)return 1;if(r)return r.length}return 0}function Y(t,e){for(var r=new Array(e);e--;)r[e]=t[e];return r}M.prototype=Object.create(null),D.EventEmitter=D,D.usingDomains=!1,D.prototype.domain=void 0,D.prototype._events=void 0,D.prototype._maxListeners=void 0,D.defaultMaxListeners=10,D.init=function(){this.domain=null,D.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new M,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},D.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||isNaN(t))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=t,this},D.prototype.getMaxListeners=function(){return I(this)},D.prototype.emit=function(t){var e,r,n,o,i,s,u,a="error"===t;if(s=this._events)a=a&&null==s.error;else if(!a)return!1;if(u=this.domain,a){if(e=arguments[1],!u){if(e instanceof Error)throw e;var c=new Error('Uncaught, unspecified "error" event. ('+e+")");throw c.context=e,c}return e||(e=new Error('Uncaught, unspecified "error" event')),e.domainEmitter=this,e.domain=u,e.domainThrown=!1,u.emit("error",e),!1}if(!(r=s[t]))return!1;var l="function"==typeof r;switch(n=arguments.length){case 1:q(r,l,this);break;case 2:U(r,l,this,arguments[1]);break;case 3:F(r,l,this,arguments[1],arguments[2]);break;case 4:$(r,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(o=new Array(n-1),i=1;i<n;i++)o[i-1]=arguments[i];z(r,l,this,o)}return!0},D.prototype.addListener=function(t,e){return H(this,t,e,!1)},D.prototype.on=D.prototype.addListener,D.prototype.prependListener=function(t,e){return H(this,t,e,!0)},D.prototype.once=function(t,e){if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');return this.on(t,J(this,t,e)),this},D.prototype.prependOnceListener=function(t,e){if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');return this.prependListener(t,J(this,t,e)),this},D.prototype.removeListener=function(t,e){var r,n,o,i,s;if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');if(!(n=this._events))return this;if(!(r=n[t]))return this;if(r===e||r.listener&&r.listener===e)0==--this._eventsCount?this._events=new M:(delete n[t],n.removeListener&&this.emit("removeListener",t,r.listener||e));else if("function"!=typeof r){for(o=-1,i=r.length;i-- >0;)if(r[i]===e||r[i].listener&&r[i].listener===e){s=r[i].listener,o=i;break}if(o<0)return this;if(1===r.length){if(r[0]=void 0,0==--this._eventsCount)return this._events=new M,this;delete n[t]}else!function(t,e){for(var r=e,n=r+1,o=t.length;n<o;r+=1,n+=1)t[r]=t[n];t.pop()}(r,o);n.removeListener&&this.emit("removeListener",t,s||e)}return this},D.prototype.off=function(t,e){return this.removeListener(t,e)},D.prototype.removeAllListeners=function(t){var e,r;if(!(r=this._events))return this;if(!r.removeListener)return 0===arguments.length?(this._events=new M,this._eventsCount=0):r[t]&&(0==--this._eventsCount?this._events=new M:delete r[t]),this;if(0===arguments.length){for(var n,o=Object.keys(r),i=0;i<o.length;++i)"removeListener"!==(n=o[i])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=new M,this._eventsCount=0,this}if("function"==typeof(e=r[t]))this.removeListener(t,e);else if(e)do{this.removeListener(t,e[e.length-1])}while(e[0]);return this},D.prototype.listeners=function(t){var e,r=this._events;return r&&(e=r[t])?"function"==typeof e?[e.listener||e]:function(t){for(var e=new Array(t.length),r=0;r<e.length;++r)e[r]=t[r].listener||t[r];return e}(e):[]},D.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):V.call(t,e)},D.prototype.listenerCount=V,D.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};let K=0;class Q extends N{constructor(t,e,r=[]){if("function"!=typeof e)throw new Error("task must be fed function");super({fn:e,args:r,status:"new",queue:t}),this.$id=++K,this.$name=e.name?e.name:this.$id}get isDone(){return!!this.isStopped||"done"===this.status}get status(){return this._value.error?"error":this.isStopped?"done":this.value.status}toJSON(){if(this.isStopped)return"stopped";const t={...this.value};return delete t.queue,t}}const R=require("lodash/once");return class extends D{constructor(t){if(t<1||"number"!=typeof t)throw new Error("ActionQueue requires a positive number for concurrency");super(),this.tasks=new N([]),this.finished=new P,this.failed=new P,this.maxConcurrent=t;const e=this;this.tasks.subscribe({next(t){t.filter(t=>"active"===t.value.status).length<e.maxConcurrent&&e.performNext()},error(t){console.warn("tasks error: ",t)},complete(){const t=e.tasks._value;t&&Array.isArray(t)&&t.forEach(t=>{t.isStopped||t.complete()})}})}performNext(){const t=this.tasks.value.find(t=>!t.isStopped&&"new"===t.value.status);t&&this.perform(t)}complete(){return this.tasks.complete()}async perform(t){if(!t)return;if(t.isStopped)return void console.warn("attempt to perform stopped task",t);const{fn:e,args:r,status:n,queue:o}=t.value;if(o!==this&&console.warn("attempt to process foreign task",t),"new"===n)try{t.next({...t.value,status:"active"});const n=await e(t,...r);if(this.tasks.isStopped)return;t.next({...t.value,status:"done",result:n}),t.isStopped||t.complete()}catch(e){console.log("error executing ",t.toJSON(),e),t.isStopped||(t.next({...t.value,status:"error",error:e}),t.complete()),this.removeTask(t)}else console.warn("attempt to perform a non-new task",t)}removeTask(t){if(this.tasks.isStopped)return;if(t.isStopped)return;const e=this.tasks.value.filter(e=>e!==t&&!e.isStopped);this.tasks.next(e)}task(t,...e){const r=new Q(this,t,e);this.tasks.next([...this.tasks.value,r]);const n=this;return r.subscribe({next(t){n.tasks.next(n.tasks.value)},error(t){}}),r}add(t,...e){const r=this.task(t,...e),n=this;return new Promise((t,e)=>{let o,i=R(()=>{t(),o.unsubscribe()});o=r.subscribe({next(t){"done"===t.status&&i(),"error"===t.status&&(e(t.error),o.unsubscribe())},error(t){n.removeTask(r),e(t)},complete(){n.removeTask(r),i()}})})}subscribe(t){return this.tasks.subscribe(t)}}}));
